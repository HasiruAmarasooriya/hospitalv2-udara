@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model ClaimBillDto;
@{
}

<form class="pt-5">
    <!-- 2 column grid layout with text inputs for the first and last names -->
    <div class="row mb-4">
        <div class="col">
            <div data-mdb-input-init class="form-outline">
                <label class="form-label" for="refNo">Ref No</label>
                <input type="text" id="refNo" class="form-control" />
            </div>
        </div>
        <div class="col">
            <div data-mdb-input-init class="form-outline">
                <label class="form-label" for="patientName">Patient Name</label>
                <select class="form-control ddlSearchList" onchange="javascript:select_onchange_patient(this.value);" asp-for="claimBill.Patient.Id" id="dropPatient">
                    <option value="-2">Select one</option>
                    @foreach (var item in Model.patientsList)
                    {
                        <option value="@item.Id">@item.FullName (@item.MobileNumber)</option>
                    }
                </select>
                @* <input type="text" id="patientName" class="form-control" /> *@
            </div>
        </div>
        <div class="col">
            <div data-mdb-input-init class="form-outline">
                <label class="form-label" for="contactNumber">Contact Number</label>
                <input type="tel" id="contactNumber" class="form-control" />
            </div>
        </div>
    </div>

    <!-- Text input -->
    <div data-mdb-input-init class="form-outline mb-4">
        <label class="form-label" for="doctorName">Doctor Name</label>
        @{
            <select class="form-control ddlSearchList" id="dropDoctor">
                <option value="1">Please Select</option>

                @foreach (var item in Model.consultantsList)
                {
                    <option value="@item.Id">@item.Name</option>
                }
                <option value="82">Investigation</option>
                <option value="83">X-RAY</option>
            </select>
        }
        @* <input type="text" id="doctorName" class="form-control" /> *@
    </div>

    <div class="row mb-4">
        <div class="col">
            <div data-mdb-input-init class="form-outline mb-4">
                <label class="form-label" for="subTotal">Subtotal (Rs.)</label>
                <input type="text" id="subTotal" class="form-control" onchange="calculate()" />
            </div>
        </div>

        <div class="col">
            <div data-mdb-input-init class="form-outline mb-4">
                <label class="form-label" for="discount">Discount (Rs.)</label>
                <input type="text" id="discount" class="form-control" onchange="calculate()" />
            </div>
        </div>

        <div class="col">
            <div data-mdb-input-init class="form-outline mb-4">
                <label class="form-label" for="totalAmount">Total Amount (Rs.)</label>
                <input type="text" id="totalAmount" class="form-control" value="0" disabled />
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <div data-mdb-input-init class="form-outline mb-4">
                <label class="form-label" for="cashPayment">Cash Payment (Rs.)</label>
                <input type="text" id="cashPayment" class="form-control" onchange="calculate()" />
            </div>
        </div>

        <div class="col">
            <div data-mdb-input-init class="form-outline mb-4">
                <label class="form-label" for="balance">Balance (Rs.)</label>
                <input type="text" id="balance" class="form-control" value="0" disabled  />
            </div>
        </div>
    </div>

    <!-- Submit button -->
    <button data-mdb-ripple-init type="button" class="btn btn-primary btn-block mb-4" onclick="PrintBill()">Print Bill</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<script>

    function calculate() {
        console.log("Calculating...");
        var subtotal = parseFloat(document.getElementById('subTotal').value);
        var discount = parseFloat(document.getElementById('discount').value);
        var cashPayment = parseFloat(document.getElementById('cashPayment').value);

        console.log(subtotal);
        console.log(discount);
        console.log(cashPayment);

        // Check if values are valid numbers
        if (isNaN(subtotal)) {
            subtotal = 0;
        }
        if (isNaN(discount)) {
            discount = 0;
        }
        if (isNaN(cashPayment)) {
            cashPayment = 0;
        }

        // Calculate total amount
        var total = subtotal - discount;

        // Calculate balance
        var balance = cashPayment - total;

        // Update the total and balance displayed
        document.getElementById('totalAmount').value = total.toFixed(2);
        document.getElementById('balance').value = balance.toFixed(2);
    }

    function select_onchange_patient(value) {

        var settings = {
            url: "/ClaimBill/LoadPatientsAjax/" + value,
            "method": "GET",
            "headers": {
                "Accept": "application/json",
                "Content-Type": "application/json"
            },
        };



        $.ajax(settings).done(function (response) {
            console.log(response);
            var data = response;

            if (data != null) {
                $('#contactNumber').val(data.mobileNumber);
            }
        });
    }

    function PrintBill() {
        var logoImage = new Image();
        var barcodeImage = new Image();
        var imagesLoaded = 0;


        logoImage.src = "https://kumuduhospital.com/assets/images/kumudu_logo2.jpg"; // Replace with your actual logo URL
        barcodeImage.src = "https://png.pngtree.com/png-clipart/20220424/original/pngtree-black-and-white-icons-of-barcode-numbers-png-image_7554658.png"; // Replace with your actual barcode URL

        // Callback function to check if all images are loaded
        function checkImagesLoaded() {
            imagesLoaded++;

            if (imagesLoaded === 2) { // You may need to adjust this count if you have more images
                openPrintWindow();
            }
        }

        // Set the load event listeners for the images
        logoImage.onload = checkImagesLoaded;
        barcodeImage.onload = checkImagesLoaded;

        function openPrintWindow() {
            var refNo = document.getElementById("refNo").value;
            var dropPatient = document.getElementById("dropPatient").value;
            var contactNumber = document.getElementById("contactNumber").value;
            var dropDoctor = document.getElementById("dropDoctor").value;
            var subTotal = document.getElementById("subTotal").value;
            var discount = document.getElementById("discount").value;
            var totalAmount = document.getElementById("totalAmount").value;
            var cashPayment = document.getElementById("cashPayment").value;
            var balance = document.getElementById("balance").value;

            var claimBill = {
                RefNo: refNo,
                PatientID: dropPatient,
                ConsultantId: dropDoctor,
                SubTotal: subTotal,
                Discount: discount,
                TotalAmount: totalAmount,
                CashAmount: cashPayment,
                Balance: balance
            }

            var claimBillDto = {
                claimBill: claimBill
            };

            console.log(claimBillDto);


            $.ajax({
                type: "POST",
                url: "/ClaimBill/AddNewClaimBill",
                data: JSON.stringify({ claimBill }),
                contentType: "application/json; charset=utf-8",
                dataType: "html",
                success: function (response) {
                    var printWindow = window.open('', '_blank', 'width=600,height=600,location=no,menubar=no');
                    printWindow.document.open();
                    printWindow.document.write(response);
                    //printWindow.document.getElementsByTagName('body')[0].style.setProperty('width', '600px'); // Set the width as needed
                    //printWindow.document.getElementsByTagName('body')[0].style.setProperty('margin', '0'); // Remove any margins
                    printWindow.document.close();
                    printWindow.print();
                    printWindow.close();
                },
                failure: function (response) {
                    alert(response.responseText);
                },
                error: function (response) {
                    alert(response.responseText);
                }
            });
        }

        // If the images are already cached, the load event may not fire, so check immediately
        if (logoImage.complete && barcodeImage.complete) {
            openPrintWindow();
        }
    }

</script>
