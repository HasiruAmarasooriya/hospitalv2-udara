@using Microsoft.Extensions.Configuration
@model AdmissionDto
@inject IConfiguration Configuration

<script type="text/javascript">

    let consultantList = [];

    function loadConsultantDetails() {
        const selectedOption = $("#consultant option:selected");

        // Set default doctor fee from option (if needed), but allow manual changes
        const doctorFee = parseFloat(selectedOption.data("doctorfee")) || 0;
        console.log('Default doctor fee:', doctorFee);

        // Set the doctor fee to input but allow manual change later
        $("#txtDoctorFee").val(doctorFee.toFixed(2));

        // Since Hospital Fee is fixed zero
        $("#txtHospitalFee").val("0.00");

        // Calculate and set total amount
        const amount = doctorFee; // No hospital fee
        $("#txtAmount").val(amount.toFixed(2));
    }

    function calculateAmount() {
        const doctorFee = parseFloat($("#txtDoctorFee").val()) || 0;
        const hospitalFee = 0; // Fixed as zero
        const amount = doctorFee + hospitalFee;
        $("#txtAmount").val(amount.toFixed(2));
    }

    function addConsultant() {
        const ConsultantId = $("#consultant").val();
        const consultantName = $("#consultant option:selected").text();
        const DocFee = parseFloat($("#txtDoctorFee").val()) || 0;
        const HospitalFee = 0; // Fixed zero
        const AdmissionId = $("#custId").val();
        const Amount = DocFee + HospitalFee;

        if (ConsultantId == 0) {
            alert("Please select a consultant.");
            return;
        }

        consultantList.push({ AdmissionId, ConsultantId, consultantName, DocFee, HospitalFee, Amount });

        const newRow = `
            <tr>
                <td>${consultantName}</td>
                <td>${DocFee.toFixed(2)}</td>
                <td>${Amount.toFixed(2)}</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeConsultant('${ConsultantId}')">Remove</button></td>
            </tr>
        `;
        $("#tempConsultantTable tbody").append(newRow);

        // Clear fields
        $("#consultant").val(0);
        $("#txtDoctorFee").val("");
        $("#txtAmount").val("");
    }

    function removeConsultant(id) {
        consultantList = consultantList.filter(c => c.ConsultantId !== id);
        $(`#tempConsultantTable tbody tr:has(button[onclick*='${id}'])`).remove();
    }

    function saveConsultants() {
        if (consultantList.length === 0) {
            alert("No consultants to save.");
            return;
        }

        $.ajax({
            type: "POST",
            url: "/Admission/AddNewConsultant",
            contentType: 'application/json',
            data: JSON.stringify(consultantList),
            success: function (response) {
                alert('Consultants saved successfully!');
                consultantList = [];
                $("#tempConsultantTable tbody").empty();
                ShowShiftDetails(@Model.AdmissionsId); // Refresh details
            },
            error: function (response) {
                alert(response.responseText);
                consultantList = [];
            }
        });
    }

</script>

<div class="modal-content">
    <div class="modal-header">
        <h4 class="modal-title" id="myLargeModalLabel">Add/Edit Consultants</h4>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="ShowShiftDetails(@Model.AdmissionsId)">×</button>
    </div>

    <div class="modal-body">
        <form asp-action="AddNewConsultant" method="post">
            <input type="hidden" id="custId" asp-for="AdmissionsId" />

            <div class="row">
                @* <div class="col-md-4"> *@
                @*     <div class="form-group"> *@
                @*         <label for="companyName">Type</label> *@
                @*         <select class="form-control ddlSearchList" name="cars" id="cars"> *@
                @*             <option value="1">Consultants</option> *@
                @*             <option value="2">Other Doctors</option> *@
                @*             <option value="3">Special Attendants</option> *@
                @*         </select> *@
                @*     </div> *@
                @* </div> *@

                <div class="col-md-4">
                    <div class="form-group">
                        <label for="consultant">Name of Consultants</label>
                        <select class="form-control ddlSearchList" onchange="loadConsultantDetails()" asp-for="AdmissionConsultants.ConsultantId" id="consultant">
                            <option value="0">Select Consultant</option>
                            @foreach (var item in Model.Consultants)
                            {
                                <option value="@item.Id" data-doctorfee="@item.DoctorFee">@item.Name - @item.Specialist.Name</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label for="txtDoctorFee">Doctor Fee</label>
                        <input class="form-control" type="text" id="txtDoctorFee" placeholder="Doctor Fee" onkeyup="calculateAmount()" />
                    </div>
                </div>

                <input type="hidden" id="txtHospitalFee" value="0.00" />

                <div class="col-md-4">
                    <div class="form-group">
                        <label for="txtAmount">Amount</label>
                        <input class="form-control" type="text" id="txtAmount" placeholder="Amount" readonly />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <button type="button" class="btn btn-success" onclick="addConsultant()">Add Consultant</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="tempConsultantTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Consultant Name</th>
                                <th>Doctor Fee</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="ShowShiftDetails(@Model.AdmissionsId)">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveConsultants()"><i class="fa fa-save"></i>&nbsp;Save</button>
            </div>
        </form>
    </div>

    <div class="modal-footer">
        <div class="col-md-12">
            <div class="table-responsive">
                <table id="myTable" class="table table-striped table-bordered dataTable fonts-12" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Consultant Name</th>
                            <th>Doctor Fee</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tblBodyPayments">
                        @foreach (var item in Model.AdmissionConsultantList)
                        {
                            <tr>
                                <td>@item.Consultant.Name</td>
                                <td>@item.DoctorFee.ToString("0.00")</td>
                                <td>@item.Amount.ToString("0.00")</td>
                                <td>
                                    @using (Html.BeginForm("DeleteAdmissionConsultant", "Admission", new { Id = @item.Id }, FormMethod.Post))
                                    {
                                        <button class='btn btn-danger btn-xs'><i class='fa fa-trash'></i></button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
